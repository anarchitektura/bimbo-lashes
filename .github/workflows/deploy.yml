name: Deploy

on:
  push:
    branches: [main]

concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Get commit info
        id: commit
        run: |
          echo "sha_short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Deploy via SSH
        id: ssh_deploy
        uses: appleboy/ssh-action@v1
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          ADMIN_TG_ID: ${{ secrets.ADMIN_TG_ID }}
          COMMIT_SHA: ${{ steps.commit.outputs.sha_short }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 25m
          envs: BOT_TOKEN,ADMIN_TG_ID,COMMIT_SHA
          script: |
            set -euo pipefail
            export BOT_TOKEN ADMIN_TG_ID

            echo "=== Deploy starting: $COMMIT_SHA ==="

            # Mark directory as safe for git
            git config --global --add safe.directory /opt/bimbo-lashes

            # Phase 0: Ensure git repo is connected to GitHub
            cd /opt/bimbo-lashes
            if ! git remote get-url origin > /dev/null 2>&1; then
              echo "--- Phase 0: Connecting to GitHub ---"
              cp .env /tmp/bimbo-env-backup 2>/dev/null || true

              git init 2>/dev/null || true
              git remote add origin https://github.com/anarchitektura/bimbo-lashes.git 2>/dev/null || true
              git remote set-url origin https://github.com/anarchitektura/bimbo-lashes.git
              git fetch origin main
              git checkout -B main origin/main

              cp /tmp/bimbo-env-backup .env 2>/dev/null || true
              rm -f /tmp/bimbo-env-backup
              chmod +x scripts/*.sh
              echo "Git repo connected"
            fi

            cd /opt/bimbo-lashes

            # Phase 1: Pre-deploy backup
            echo "--- Phase 1: Pre-deploy backup ---"
            if [[ -f ./scripts/backup.sh ]]; then
              ./scripts/backup.sh || echo "WARNING: Pre-deploy backup failed (continuing)"
            else
              echo "SKIP: backup.sh not found (first deploy)"
            fi

            # Phase 2: Tag current images as :previous (for rollback)
            echo "--- Phase 2: Tag previous images ---"
            for SVC in server bot web; do
              IMG="bimbo-lashes-${SVC}"
              if docker image inspect "${IMG}:latest" > /dev/null 2>&1; then
                docker tag "${IMG}:latest" "${IMG}:previous"
                echo "Tagged ${IMG}:previous"
              fi
            done

            # Phase 3: Pull & build
            echo "--- Phase 3: Pull & build ---"
            git fetch origin main
            git reset --hard origin/main
            chmod +x scripts/*.sh

            # Update Caddyfile if changed
            if [[ -f /etc/caddy/Caddyfile ]]; then
              DOMAIN=$(grep -oP '^\S+' /etc/caddy/Caddyfile | head -1)
              if [[ -n "$DOMAIN" ]] && [[ "$DOMAIN" != "{domain}" ]]; then
                sed "s/{domain}/$DOMAIN/g" infra/Caddyfile > /etc/caddy/Caddyfile
                systemctl reload caddy || true
                echo "Caddyfile updated"
              fi
            fi

            docker compose build

            # Phase 4: Deploy
            echo "--- Phase 4: Deploy ---"
            docker compose up -d

            # Phase 5: Health check (20 attempts x 5s = 100s max wait)
            echo "--- Phase 5: Health check ---"
            if ./scripts/health-check.sh 20 5; then
              echo "=== Deploy successful ==="

              docker image prune -f
              for SVC in server bot web; do
                docker rmi "bimbo-lashes-${SVC}:previous" 2>/dev/null || true
              done

              AUTHOR=$(git log -1 --format='%an')
              MSG=$(git log -1 --format='%s')
              ./scripts/notify.sh "Deployed $COMMIT_SHA by $AUTHOR: $MSG"
            else
              echo "=== Health check FAILED ==="

              # Capture recent container logs for diagnostics
              LOGS=$(docker compose logs --tail=30 --no-color server 2>&1 | tail -20 || echo "No logs available")

              # Only rollback if previous images have /api/health support
              if docker run --rm "bimbo-lashes-server:previous" sh -c "test -f /usr/bin/curl" 2>/dev/null; then
                echo "Rolling back..."
                if ./scripts/rollback.sh; then
                  ./scripts/notify.sh "$(printf 'ðŸ”´ <b>Deploy FAILED</b> (%s), rolled back\n\nLast server logs:\n<pre>%s</pre>' "$COMMIT_SHA" "$LOGS")"
                else
                  ./scripts/notify.sh "$(printf 'ðŸš¨ <b>CRITICAL</b>: Deploy %s failed AND rollback failed!\n\nLast server logs:\n<pre>%s</pre>' "$COMMIT_SHA" "$LOGS")"
                fi
              else
                echo "SKIP rollback: previous images incompatible (first DevOps deploy)"
                ./scripts/notify.sh "$(printf 'ðŸ”´ <b>Deploy FAILED</b> (%s). No rollback available.\n\nLast server logs:\n<pre>%s</pre>' "$COMMIT_SHA" "$LOGS")"
              fi
              exit 1
            fi

      - name: Notify on SSH failure
        if: failure() && steps.ssh_deploy.outcome == 'failure'
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          ADMIN_TG_ID: ${{ secrets.ADMIN_TG_ID }}
          SHA: ${{ steps.commit.outputs.sha_short }}
          ACTOR: ${{ github.actor }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          TEXT=$(printf 'ðŸ”´ <b>Deploy FAILED</b> â€” SSH error\n\nðŸ“¦ <code>%s</code> by %s\n\nðŸ”— <a href="%s">Actions log</a>' \
            "$SHA" "$ACTOR" "$RUN_URL")

          curl -sf -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg chat "$ADMIN_TG_ID" \
              --arg text "$TEXT" \
              '{chat_id: ($chat|tonumber), text: $text, parse_mode: "HTML", disable_web_page_preview: true}')" \
            || echo "WARNING: Could not send Telegram notification"
